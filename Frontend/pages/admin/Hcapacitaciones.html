<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Capacitaciones | Sistema RoomIT</title>
    
    <!-- Bootstrap 5.33 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="bg-primary bg-gradient text-white py-4 mb-4 shadow-sm">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2 fw-bold">
                        <i class="bi bi-mortarboard-fill me-3"></i>
                        Gesti√≥n de Capacitaciones
                    </h1>
                    <p class="mb-0 opacity-90">Administra materiales de capacitaci√≥n y recursos educativos</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-light btn-lg px-4 shadow-sm" onclick="nuevaCapacitacion()">
                        <i class="bi bi-plus-lg me-2"></i>
                        Nueva Capacitaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm bg-success bg-opacity-10">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-success mb-1">Total Activas</h6>
                                <h4 class="text-success mb-0 fw-bold" id="totalActivas">-</h4>
                            </div>
                            <i class="bi bi-check-circle-fill text-success fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm bg-info bg-opacity-10">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-info mb-1">Archivos PDF</h6>
                                <h4 class="text-info mb-0 fw-bold" id="totalPDF">-</h4>
                            </div>
                            <i class="bi bi-file-earmark-pdf-fill text-info fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm bg-warning bg-opacity-10">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-warning mb-1">Archivos Word</h6>
                                <h4 class="text-warning mb-0 fw-bold" id="totalWord">-</h4>
                            </div>
                            <i class="bi bi-file-earmark-word-fill text-warning fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-0 shadow-sm bg-danger bg-opacity-10">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-danger mb-1">Inactivas</h6>
                                <h4 class="text-danger mb-0 fw-bold" id="totalInactivas">-</h4>
                            </div>
                            <i class="bi bi-x-circle-fill text-danger fs-1 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" placeholder="Buscar capacitaciones..." id="searchInput">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterTipo">
                            <option value="">Todos los tipos</option>
                            <option value="PDF">Archivos PDF</option>
                            <option value="WORD">Archivos Word</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterEstado">
                            <option value="">Todos los estados</option>
                            <option value="1">Activos</option>
                            <option value="0">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-table me-2 text-primary"></i>
                        Lista de Capacitaciones
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="exportarExcel()">
                            <i class="bi bi-download me-1"></i>
                            Exportar
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="cargarCapacitaciones()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Actualizar
            </button>
        </div>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3 text-muted">Cargando capacitaciones...</p>
                </div>

                <!-- Table -->
        <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="px-3 py-3 fw-semibold text-muted">
                                    <i class="bi bi-hash me-1"></i>ID
                                </th>
                                <th class="px-3 py-3 fw-semibold text-muted">
                                    <i class="bi bi-card-text me-1"></i>T√≠tulo
                                </th>
                                <th class="px-3 py-3 fw-semibold text-muted">
                                    <i class="bi bi-chat-square-text me-1"></i>Descripci√≥n
                                </th>
                                <th class="px-3 py-3 fw-semibold text-muted text-center">
                                    <i class="bi bi-file-earmark me-1"></i>Tipo
                                </th>
                                <th class="px-3 py-3 fw-semibold text-muted text-center">
                                    <i class="bi bi-calendar me-1"></i>Fecha
                                </th>
                                <th class="px-3 py-3 fw-semibold text-muted text-center">
                                    <i class="bi bi-toggle-on me-1"></i>Estado
                                </th>
                                <th class="px-3 py-3 fw-semibold text-muted text-center">
                                    <i class="bi bi-gear me-1"></i>Acciones
                                </th>
                    </tr>
                </thead>
                <tbody id="tablaCapacitaciones">
                            <!-- Content will be loaded here -->
                </tbody>
            </table>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox display-1 text-muted opacity-50"></i>
                    <h4 class="text-muted mt-3">No hay capacitaciones</h4>
                    <p class="text-muted">No se encontraron capacitaciones que coincidan con los filtros aplicados.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#capacitacionModal">
                        <i class="bi bi-plus-lg me-2"></i>
                        Crear Primera Capacitaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Capacitaci√≥n -->
    <div class="modal fade" id="capacitacionModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <form id="capacitacionForm" enctype="multipart/form-data" method="POST">
                    <div class="modal-header bg-primary bg-gradient text-white">
                        <h5 class="modal-title fw-bold" id="modalTitle">
                            <i class="bi bi-plus-circle me-2"></i>
                            Nueva Capacitaci√≥n
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="hidden" id="capacitacionId" name="id">
                        
                        <!-- T√≠tulo -->
                        <div class="mb-4">
                            <label for="titulo" class="form-label fw-semibold">
                                <i class="bi bi-card-text text-primary me-2"></i>
                                T√≠tulo de la Capacitaci√≥n
                            </label>
                            <input type="text" class="form-control form-control-lg" id="titulo" name="titulo" required 
                                   placeholder="Ej: Curso de Seguridad Laboral">
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Ingresa un t√≠tulo descriptivo y claro
                            </div>
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="mb-4">
                            <label for="descripcion" class="form-label fw-semibold">
                                <i class="bi bi-chat-square-text text-primary me-2"></i>
                                Descripci√≥n (Opcional)
                            </label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" 
                                      placeholder="Describe brevemente el contenido de esta capacitaci√≥n..."></textarea>
                        </div>

                        <div class="row">
                            <!-- Tipo de Archivo -->
                            <div class="col-md-6 mb-4">
                                <label for="tipoArchivo" class="form-label fw-semibold">
                                    <i class="bi bi-file-earmark text-primary me-2"></i>
                                    Tipo de Archivo
                                </label>
                                <select class="form-select form-select-lg" id="tipoArchivo" name="tipo_archivo" required>
                                <option value="">Seleccione un tipo</option>
                                    <option value="PDF">
                                        <i class="bi bi-file-earmark-pdf"></i> Documento PDF
                                    </option>
                                    <option value="WORD">
                                        <i class="bi bi-file-earmark-word"></i> Documento Word
                                    </option>
                            </select>
                        </div>

                            <!-- Estado -->
                            <div class="col-md-6 mb-4">
                                <label for="estado" class="form-label fw-semibold">
                                    <i class="bi bi-toggle-on text-primary me-2"></i>
                                    Estado
                                </label>
                                <select class="form-select form-select-lg" id="estado" name="estado" required>
                                    <option value="1">
                                        <i class="bi bi-check-circle"></i> Activo
                                    </option>
                                    <option value="0">
                                        <i class="bi bi-x-circle"></i> Inactivo
                                    </option>
                            </select>
                        </div>
                    </div>

                        <!-- Upload de Archivo -->
                        <div class="mb-4">
                            <label for="archivo" class="form-label fw-semibold">
                                <i class="bi bi-upload text-primary me-2"></i>
                                Archivo de Capacitaci√≥n
                            </label>
                            <div class="input-group">
                                <input type="file" class="form-control form-control-lg" id="archivo" name="archivo" 
                                       accept=".pdf,.doc,.docx">
                                <span class="input-group-text">
                                    <i class="bi bi-paperclip"></i>
                                </span>
                            </div>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Archivos permitidos:</strong> PDF, DOC, DOCX (m√°ximo 10MB)
                                <br>
                                <span class="text-muted">Solo requerido para nuevas capacitaciones. Para editar, deja vac√≠o para mantener el archivo actual.</span>
                            </div>
                        </div>

                        <!-- File Preview -->
                        <div id="filePreview" class="alert alert-info d-none">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark-check fs-3 me-3"></i>
                                <div>
                                    <strong>Archivo seleccionado:</strong>
                                    <div id="fileName" class="text-muted"></div>
                                    <small id="fileSize" class="text-muted"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-2"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary px-4" id="guardarCapacitacion">
                            <i class="bi bi-check-lg me-2"></i>
                            Guardar Capacitaci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Eliminaci√≥n -->
    <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger bg-gradient text-white">
                    <h5 class="modal-title fw-bold" id="confirmarEliminarLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Confirmar Eliminaci√≥n
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <i class="bi bi-trash3 display-1 text-danger opacity-50 mb-3"></i>
                    <h4 class="mb-3">¬øEst√°s seguro?</h4>
                    <p class="text-muted">Esta acci√≥n desactivar√° la capacitaci√≥n y no podr√° ser revertida f√°cilmente.</p>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-2"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger px-4" id="confirmarEliminar">
                        <i class="bi bi-trash3 me-2"></i>
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong class="me-auto">√âxito</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="successMessage">
                Operaci√≥n completada exitosamente
            </div>
        </div>
        
        <div id="errorToast" class="toast border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="errorMessage">
                Ha ocurrido un error
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.33 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ‚úÖ RUTA CORREGIDA
        const PHP_ENDPOINT = '../../../Backend/CRUD-admin/crud-capacitaciones.php';

        // ‚úÖ VARIABLES GLOBALES MEJORADAS
        let capacitacionesData = [];
        let filtrosActivos = {
            busqueda: '',
            tipo: '',
            estado: ''
        };

        // ‚úÖ FUNCIONES DE UI MEJORADAS
        function mostrarLoading(show = true) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('tablaCapacitaciones').style.display = show ? 'none' : '';
        }

        function mostrarToast(tipo, mensaje) {
            const toastId = tipo === 'success' ? 'successToast' : 'errorToast';
            const messageId = tipo === 'success' ? 'successMessage' : 'errorMessage';
            
            document.getElementById(messageId).textContent = mensaje;
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
        }

        function actualizarEstadisticas() {
            const stats = {
                total: capacitacionesData.length,
                activas: capacitacionesData.filter(c => c.estado == 1).length,
                inactivas: capacitacionesData.filter(c => c.estado == 0).length,
                pdf: capacitacionesData.filter(c => c.archivo_tipo === 'PDF').length,
                word: capacitacionesData.filter(c => c.archivo_tipo === 'WORD').length
            };

            document.getElementById('totalActivas').textContent = stats.activas;
            document.getElementById('totalInactivas').textContent = stats.inactivas;
            document.getElementById('totalPDF').textContent = stats.pdf;
            document.getElementById('totalWord').textContent = stats.word;
        }

        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getTipoIcon(tipo) {
            return tipo === 'PDF' ? 
                '<i class="bi bi-file-earmark-pdf-fill text-danger"></i>' : 
                '<i class="bi bi-file-earmark-word-fill text-primary"></i>';
        }

        function getTipoBadge(tipo) {
            return tipo === 'PDF' ? 
                '<span class="badge bg-danger-subtle text-danger"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</span>' : 
                '<span class="badge bg-primary-subtle text-primary"><i class="bi bi-file-earmark-word me-1"></i>Word</span>';
        }

        function getEstadoBadge(estado) {
            return estado == 1 ? 
                '<span class="badge bg-success-subtle text-success"><i class="bi bi-check-circle me-1"></i>Activo</span>' : 
                '<span class="badge bg-danger-subtle text-danger"><i class="bi bi-x-circle me-1"></i>Inactivo</span>';
        }

        // ‚úÖ VALIDACI√ìN DE ARCHIVO MEJORADA
        function validarArchivo(file) {
            const tipoArchivo = document.getElementById('tipoArchivo').value;
            const extension = file.name.split('.').pop().toUpperCase();
            
            if (tipoArchivo === 'PDF' && extension !== 'PDF') {
                mostrarToast('error', 'El archivo debe ser PDF');
                return false;
            }
            if (tipoArchivo === 'WORD' && !['DOC', 'DOCX'].includes(extension)) {
                mostrarToast('error', 'El archivo debe ser DOC o DOCX');
                return false;
            }

            // Validar tama√±o (10MB)
            if (file.size > 10 * 1024 * 1024) {
                mostrarToast('error', 'El archivo es demasiado grande. M√°ximo permitido: 10MB');
                return false;
            }

            return true;
        }

        function validarFormulario() {
            const titulo = document.getElementById('titulo').value.trim();
            const tipoArchivo = document.getElementById('tipoArchivo').value;
            const archivo = document.getElementById('archivo').files[0];
            const id = document.getElementById('capacitacionId').value;

            if (!titulo) {
                mostrarToast('error', 'El t√≠tulo es requerido');
                return false;
            }

            if (!tipoArchivo) {
                mostrarToast('error', 'Debe seleccionar un tipo de archivo');
                return false;
            }

            if (!id && !archivo) {
                mostrarToast('error', 'Debe seleccionar un archivo para crear una nueva capacitaci√≥n');
                return false;
            }

            if (archivo && !validarArchivo(archivo)) {
                return false;
            }

            return true;
        }

        // ‚úÖ MANEJO DEL FORMULARIO MEJORADO
        document.getElementById('capacitacionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validarFormulario()) {
                return;
            }

            const formData = new FormData(this);

            // ‚úÖ DEBUGGING DEL FRONTEND
            const capacitacionId = document.getElementById('capacitacionId').value;
            console.log('üîç DEBUG FRONTEND:', {
                'ID del formulario': capacitacionId,
                'Es edici√≥n': capacitacionId !== '',
                'FormData ID': formData.get('id'),
                'T√≠tulo': formData.get('titulo')
            });

            // ‚úÖ ASEGURAR QUE EL ID SE ENV√çA CORRECTAMENTE
            if (capacitacionId && capacitacionId !== '') {
                formData.set('id', capacitacionId);
                console.log('‚úÖ ID establecido en FormData:', formData.get('id'));
            }

            const btnGuardar = document.getElementById('guardarCapacitacion');
            
            // Deshabilitar el bot√≥n y mostrar spinner
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Guardando...';

            fetch(PHP_ENDPOINT, {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('La respuesta del servidor no es JSON v√°lido');
                }

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
                
                return data;
            })
            .then(resp => {
                console.log('üéØ Respuesta del servidor:', resp);
                if (resp.success) {
                    const isEdit = document.getElementById('capacitacionId').value !== '';
                    mostrarToast('success', resp.mensaje);
                    console.log(`‚úÖ ${isEdit ? 'Actualizaci√≥n' : 'Creaci√≥n'} exitosa`);
                    cargarCapacitaciones();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('capacitacionModal'));
                    modal.hide();
                    this.reset();
                    limpiarPreviewArchivo();
                } else {
                    throw new Error(resp.error || 'Error desconocido');
                }
            })
            .catch(err => {
                console.error('Error completo:', err);
                
                // Mejor identificaci√≥n del tipo de error
                let mensaje = 'Error al guardar: ';
                if (err.message.includes('JSON')) {
                    mensaje += 'Respuesta inv√°lida del servidor. Revisa la consola para m√°s detalles.';
                } else if (err.message.includes('fetch')) {
                    mensaje += 'Error de conexi√≥n con el servidor.';
                } else {
                    mensaje += err.message;
                }
                
                mostrarToast('error', mensaje);
            })
            .finally(() => {
                // Restaurar el bot√≥n
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = '<i class="bi bi-check-lg me-2"></i>Guardar Capacitaci√≥n';
            });
        });

        // ‚úÖ CARGA DE CAPACITACIONES MEJORADA
        function cargarCapacitaciones() {
            mostrarLoading(true);
            document.getElementById('emptyState').style.display = 'none';

            fetch(PHP_ENDPOINT)
                .then(res => res.json())
                .then(data => {
                    capacitacionesData = data;
                    renderizarTabla(data);
                    actualizarEstadisticas();
                })
                .catch(err => {
                    console.error('Error al cargar capacitaciones:', err);
                    
                    let mensaje = 'Error al cargar las capacitaciones';
                    if (err.name === 'TypeError' && err.message.includes('fetch')) {
                        mensaje += ': No se pudo conectar con el servidor. Verifica que el servidor est√© funcionando.';
                    } else if (err.message.includes('JSON')) {
                        mensaje += ': Respuesta inv√°lida del servidor.';
                    } else {
                        mensaje += ': ' + err.message;
                    }
                    
                    mostrarToast('error', mensaje);
                    document.getElementById('tablaCapacitaciones').innerHTML = 
                        `<tr><td colspan="7" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-triangle fs-1 mb-3"></i><br>
                            ${mensaje}
                        </td></tr>`;
                })
                .finally(() => {
                    mostrarLoading(false);
                });
        }

        function renderizarTabla(data) {
            const tbody = document.getElementById('tablaCapacitaciones');
            
            if (data.length === 0) {
                    tbody.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                        return;
                    }

            document.getElementById('emptyState').style.display = 'none';
            
            tbody.innerHTML = data.map(cap => `
                <tr class="border-0">
                    <td class="px-3 py-3">
                        <span class="badge bg-primary-subtle text-primary fs-6">#${cap.id}</span>
                    </td>
                    <td class="px-3 py-3">
                        <div class="fw-semibold text-dark">${cap.titulo}</div>
                        <small class="text-muted">${cap.archivo_nombre || 'Sin archivo'}</small>
                    </td>
                    <td class="px-3 py-3">
                        <div class="text-truncate" style="max-width: 200px;" title="${cap.descripcion || ''}">
                            ${cap.descripcion || '<span class="text-muted fst-italic">Sin descripci√≥n</span>'}
                        </div>
                    </td>
                    <td class="px-3 py-3 text-center">
                        ${getTipoBadge(cap.archivo_tipo)}
                    </td>
                    <td class="px-3 py-3 text-center">
                        <small class="text-muted">${formatearFecha(cap.fecha_creacion)}</small>
                    </td>
                    <td class="px-3 py-3 text-center">
                        ${getEstadoBadge(cap.estado)}
                                </td>
                    <td class="px-3 py-3 text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarCapacitacion(${cap.id})" 
                                    data-bs-toggle="tooltip" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                            <button class="btn btn-sm btn-outline-info" onclick="descargarArchivo(${cap.id})" 
                                    data-bs-toggle="tooltip" title="Descargar">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="mostrarModalEliminar(${cap.id})" 
                                    data-bs-toggle="tooltip" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                        </div>
                                </td>
                            </tr>
            `).join('');

            // Activar tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // ‚úÖ FUNCIONES CRUD MANTENIDAS
        function descargarArchivo(id) {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch(`${PHP_ENDPOINT}?id=${id}&download=1`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al descargar el archivo');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    mostrarToast('success', 'Archivo descargado exitosamente');
                })
                .catch(err => {
                    console.error('Error:', err);
                    mostrarToast('error', 'Error al descargar el archivo');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                });
        }

        function editarCapacitacion(id) {
            console.log('üîß Editando capacitaci√≥n ID:', id);
            
            fetch(`${PHP_ENDPOINT}?id=${id}`)
                .then(res => res.json())
                .then(cap => {
                    if (cap && cap.length > 0) {
                        cap = cap[0];
                        console.log('üìÑ Datos obtenidos:', cap);
                        
                        document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Capacitaci√≥n';
                        document.getElementById('capacitacionId').value = cap.id;
                        document.getElementById('titulo').value = cap.titulo;
                        document.getElementById('descripcion').value = cap.descripcion || '';
                        document.getElementById('tipoArchivo').value = cap.archivo_tipo;
                        document.getElementById('estado').value = cap.estado ? '1' : '0';
                        document.getElementById('archivo').required = false;
                        
                        console.log('‚úÖ ID establecido en el campo:', document.getElementById('capacitacionId').value);
                        
                        var modal = new bootstrap.Modal(document.getElementById('capacitacionModal'));
                        modal.show();
                    } else {
                        mostrarToast('error', 'No se encontr√≥ la capacitaci√≥n');
                    }
                })
                .catch(err => {
                    console.error('Error al obtener capacitaci√≥n:', err);
                    mostrarToast('error', 'Error al obtener capacitaci√≥n');
                });
        }

        let idAEliminar = null;
        function mostrarModalEliminar(id) {
            idAEliminar = id;
            var modal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
            modal.show();
        }

        document.getElementById('confirmarEliminar').onclick = function() {
            const btn = this;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Eliminando...';

            fetch(PHP_ENDPOINT, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: idAEliminar })
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    cargarCapacitaciones();
                    var modal = bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarModal'));
                    modal.hide();
                    mostrarToast('success', resp.mensaje || 'Capacitaci√≥n eliminada exitosamente');
                } else {
                    throw new Error(resp.error || 'Error desconocido');
                }
            })
            .catch(err => {
                console.error('Error al eliminar:', err);
                mostrarToast('error', 'Error al eliminar: ' + err.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            });
        };

        // ‚úÖ PREVIEW DEL ARCHIVO
        function limpiarPreviewArchivo() {
            document.getElementById('filePreview').classList.add('d-none');
        }

        document.getElementById('archivo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                document.getElementById('filePreview').classList.remove('d-none');
            } else {
                limpiarPreviewArchivo();
            }
        });

        // ‚úÖ FILTROS MEJORADOS
        function aplicarFiltros() {
            let dataFiltrada = capacitacionesData;

            if (filtrosActivos.busqueda) {
                const busqueda = filtrosActivos.busqueda.toLowerCase();
                dataFiltrada = dataFiltrada.filter(cap => 
                    cap.titulo.toLowerCase().includes(busqueda) ||
                    (cap.descripcion && cap.descripcion.toLowerCase().includes(busqueda))
                );
            }

            if (filtrosActivos.tipo) {
                dataFiltrada = dataFiltrada.filter(cap => cap.archivo_tipo === filtrosActivos.tipo);
            }

            if (filtrosActivos.estado !== '') {
                dataFiltrada = dataFiltrada.filter(cap => cap.estado == filtrosActivos.estado);
            }

            renderizarTabla(dataFiltrada);
        }

        function limpiarFiltros() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterEstado').value = '';
            filtrosActivos = { busqueda: '', tipo: '', estado: '' };
            aplicarFiltros();
        }

        // Event listeners para filtros
        document.getElementById('searchInput').addEventListener('input', function(e) {
            filtrosActivos.busqueda = e.target.value;
            aplicarFiltros();
        });

        document.getElementById('filterTipo').addEventListener('change', function(e) {
            filtrosActivos.tipo = e.target.value;
            aplicarFiltros();
        });

        document.getElementById('filterEstado').addEventListener('change', function(e) {
            filtrosActivos.estado = e.target.value;
            aplicarFiltros();
        });

        // ‚úÖ FUNCI√ìN DE EXPORTAR (PLACEHOLDER)
        function exportarExcel() {
            mostrarToast('info', 'Funci√≥n de exportaci√≥n en desarrollo');
        }

        // ‚úÖ RESETEAR MODAL AL ABRIR
        document.getElementById('capacitacionModal').addEventListener('show.bs.modal', function (event) {
            const form = document.getElementById('capacitacionForm');
            const btnGuardar = document.getElementById('guardarCapacitacion');
            
            // ‚úÖ SOLO resetear si NO es edici√≥n
            const isEditing = document.getElementById('capacitacionId').value !== '';
            
            if (!isEditing) {
                form.reset();
                document.getElementById('capacitacionId').value = '';
                document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Capacitaci√≥n';
                document.getElementById('estado').value = '1';
                document.getElementById('archivo').required = true;
                limpiarPreviewArchivo();
            }
            
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="bi bi-check-lg me-2"></i>Guardar Capacitaci√≥n';
        });

        // ‚úÖ CARGAR AL INICIALIZAR
        window.onload = cargarCapacitaciones;

        function nuevaCapacitacion() {
            // Limpiar el formulario para nueva capacitaci√≥n
            const form = document.getElementById('capacitacionForm');
            form.reset();
            document.getElementById('capacitacionId').value = '';
            document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nueva Capacitaci√≥n';
            document.getElementById('estado').value = '1';
            document.getElementById('archivo').required = true;
            limpiarPreviewArchivo();
            
            // Mostrar el modal
            var modal = new bootstrap.Modal(document.getElementById('capacitacionModal'));
            modal.show();
        }
    </script>
</body>
</html>
