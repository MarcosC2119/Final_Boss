<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Capacitaciones</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Capacitaciones</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#capacitacionModal">
                <i class="bi bi-plus-lg"></i> Nueva Capacitación
            </button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Descripción</th>
                        <th>Tipo</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCapacitaciones">
                    <!-- Aquí se cargan las capacitaciones -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Crear/Editar Capacitación -->
    <div class="modal fade" id="capacitacionModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="capacitacionForm" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Nueva Capacitación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="capacitacionId" name="id">
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Título</label>
                            <input type="text" class="form-control" id="titulo" name="titulo" required>
                        </div>
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcion" name="descripcion" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="tipoArchivo" class="form-label">Tipo de Archivo</label>
                            <select class="form-select" id="tipoArchivo" name="tipo_archivo" required>
                                <option value="">Seleccione un tipo</option>
                                <option value="PDF">PDF</option>
                                <option value="WORD">WORD</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="archivo" class="form-label">Archivo (PDF o Word)</label>
                            <input type="file" class="form-control" id="archivo" name="archivo" accept=".pdf,.doc,.docx">
                            <small class="text-muted">Solo se requiere para nuevas capacitaciones. Para editar, deja vacío para mantener el archivo actual.</small>
                        </div>
                        <div class="mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="1">Activo</option>
                                <option value="0">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="guardarCapacitacion">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Eliminación -->
    <div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmarEliminarLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas eliminar esta capacitación?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Aquí va tu JS para llamar a los métodos PHP -->
    <script>
        // Cambia esta ruta si tu estructura es diferente
        const PHP_ENDPOINT = '/REPO-Prototipado/Backend/CRUD-admin/crud-capacitaciones.php';

        // Función para validar el archivo antes de subir
        function validarArchivo(file) {
            const tipoArchivo = document.getElementById('tipoArchivo').value;
            const extension = file.name.split('.').pop().toUpperCase();
            
            if (tipoArchivo === 'PDF' && extension !== 'PDF') {
                alert('El archivo debe ser PDF');
                return false;
            }
            if (tipoArchivo === 'WORD' && !['DOC', 'DOCX'].includes(extension)) {
                alert('El archivo debe ser DOC o DOCX');
                return false;
            }

            // Validar tamaño (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo permitido: 10MB');
                return false;
            }

            return true;
        }

        // Función para validar el formulario
        function validarFormulario() {
            const titulo = document.getElementById('titulo').value.trim();
            const tipoArchivo = document.getElementById('tipoArchivo').value;
            const archivo = document.getElementById('archivo').files[0];
            const id = document.getElementById('capacitacionId').value;

            if (!titulo) {
                alert('El título es requerido');
                return false;
            }

            if (!tipoArchivo) {
                alert('Debe seleccionar un tipo de archivo');
                return false;
            }

            if (!id && !archivo) {
                alert('Debe seleccionar un archivo para crear una nueva capacitación');
                return false;
            }

            if (archivo && !validarArchivo(archivo)) {
                return false;
            }

            return true;
        }

        // Manejar el envío del formulario
        document.getElementById('capacitacionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validarFormulario()) {
                return;
            }

            const formData = new FormData(this);
            const btnGuardar = document.getElementById('guardarCapacitacion');
            
            // Deshabilitar el botón y mostrar spinner
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

            // Log de los datos que se envían
            console.log('Enviando datos:', {
                titulo: formData.get('titulo'),
                tipo_archivo: formData.get('tipo_archivo'),
                estado: formData.get('estado'),
                tieneArchivo: formData.get('archivo') ? 'Sí' : 'No'
            });

            fetch(PHP_ENDPOINT, {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('La respuesta del servidor no es JSON válido');
                }

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error en la respuesta del servidor');
                }
                
                return data;
            })
            .then(resp => {
                if (resp.success) {
                    alert(resp.mensaje);
                    cargarCapacitaciones();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('capacitacionModal'));
                    modal.hide();
                    this.reset();
                } else {
                    throw new Error(resp.error || 'Error desconocido');
                }
            })
            .catch(err => {
                console.error('Error completo:', err);
                alert('Error al guardar: ' + err.message);
            })
            .finally(() => {
                // Restaurar el botón
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = 'Guardar';
            });
        });

        function cargarCapacitaciones() {
            // Mostrar indicador de carga
            const tbody = document.getElementById('tablaCapacitaciones');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Cargando...</span></div></td></tr>';

            fetch(PHP_ENDPOINT)
                .then(res => res.json())
                .then(data => {
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay capacitaciones registradas</td></tr>';
                        return;
                    }
                    data.forEach(cap => {
                        const fecha = new Date(cap.fecha_creacion).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        tbody.innerHTML += `
                            <tr>
                                <td>${cap.id}</td>
                                <td>${cap.titulo}</td>
                                <td>${cap.descripcion || ''}</td>
                                <td>${cap.archivo_tipo}</td>
                                <td>${fecha}</td>
                                <td>
                                    <span class="badge ${cap.estado ? 'bg-success' : 'bg-danger'}">
                                        ${cap.estado ? 'Activo' : 'Inactivo'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editarCapacitacion(${cap.id})" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="mostrarModalEliminar(${cap.id})" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="descargarArchivo(${cap.id})" title="Descargar">
                                        <i class="bi bi-file-earmark-arrow-down"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('Error al cargar capacitaciones:', err);
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error al cargar las capacitaciones</td></tr>';
                });
        }

        function descargarArchivo(id) {
            // Mostrar indicador de carga
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            fetch(`${PHP_ENDPOINT}?id=${id}&download=1`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al descargar el archivo');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Crear URL del blob y descargar
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = ''; // El nombre del archivo vendrá del servidor
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Error al descargar el archivo. Por favor, intenta nuevamente.');
                })
                .finally(() => {
                    // Restaurar botón
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                });
        }

        function editarCapacitacion(id) {
            fetch(`${PHP_ENDPOINT}?id=${id}`)
                .then(res => res.json())
                .then(cap => {
                    if (cap && cap.length > 0) {
                        cap = cap[0];
                        document.getElementById('modalTitle').innerText = 'Editar Capacitación';
                        document.getElementById('capacitacionId').value = cap.id;
                        document.getElementById('titulo').value = cap.titulo;
                        document.getElementById('descripcion').value = cap.descripcion || '';
                        document.getElementById('tipoArchivo').value = cap.archivo_tipo;
                        document.getElementById('estado').value = cap.estado ? '1' : '0';
                        document.getElementById('archivo').required = false; // No requerido en edición
                        var modal = new bootstrap.Modal(document.getElementById('capacitacionModal'));
                        modal.show();
                    } else {
                        alert('No se encontró la capacitación.');
                    }
                })
                .catch(err => {
                    console.error('Error al obtener capacitación:', err);
                    alert('Error al obtener capacitación. Revisa la consola para más detalles.');
                });
        }

        let idAEliminar = null;
        function mostrarModalEliminar(id) {
            idAEliminar = id;
            var modal = new bootstrap.Modal(document.getElementById('confirmarEliminarModal'));
            modal.show();
        }

        document.getElementById('confirmarEliminar').onclick = function() {
            fetch(PHP_ENDPOINT, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: idAEliminar })
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    cargarCapacitaciones();
                    var modal = bootstrap.Modal.getInstance(document.getElementById('confirmarEliminarModal'));
                    modal.hide();
                } else {
                    console.error('Error al eliminar:', resp.error);
                    alert('Error al eliminar: ' + (resp.error || 'Error desconocido.'));
                }
            })
            .catch(err => {
                console.error('Error en la petición fetch (eliminar):', err);
                alert('Error en la petición al eliminar. Revisa la consola para más detalles.');
            });
        };

        // Modificar el evento del modal para resetear el formulario
        document.getElementById('capacitacionModal').addEventListener('show.bs.modal', function (event) {
            const form = document.getElementById('capacitacionForm');
            const btnGuardar = document.getElementById('guardarCapacitacion');
            
            // Resetear el formulario
            form.reset();
            document.getElementById('capacitacionId').value = '';
            document.getElementById('modalTitle').innerText = 'Nueva Capacitación';
            document.getElementById('estado').value = '1';
            
            // Restaurar el botón guardar
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = 'Guardar';
        });

        window.onload = cargarCapacitaciones;
    </script>
</body>
</html>
